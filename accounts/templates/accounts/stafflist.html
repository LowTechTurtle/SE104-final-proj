{% extends "store/base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid p-4">
    <div class="d-flex justify-content-between mb-3">
        <h3 class="text-success">Staff List</h3>
        
        <!-- Nút Add Staff đã được xóa theo yêu cầu -->
        
        <!-- Giữ lại nút Export -->
        <a class="btn btn-success" href="#">
            <i class="fa-solid fa-download"></i> Export to Excel
        </a>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead class="thead-light">
                    <tr>
                        <th>ID</th>
                        <th>Profile Image</th>
                        <th>Username</th>
                        <th>Phone Number</th>
                        <!-- Cột Status đã xóa -->
                        <th>Role</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in profiles %}
                    <tr>
                        <td>{{ p.id }}</td>
                        <td>
                            {% if p.profile_picture %}
                                <img src="{{ p.profile_picture.url }}" class="rounded-circle" width="40" height="40" style="object-fit: cover;">
                            {% else %}
                                <img src="{% static 'img/default-profile.png' %}" class="rounded-circle" width="40" height="40" style="object-fit: cover;">
                            {% endif %}
                        </td>
                        <td>{{ p.user.username }}</td>
                        <td>{{ p.telephone }}</td>
                        
                        <!-- Hiển thị Role với Badge màu sắc -->
                        <td>
                            {% if p.role == 'Admin' %}
                                <span class="badge bg-danger">Admin</span>
                            {% elif p.role == 'Manager' %}
                                <span class="badge bg-primary">Manager</span>
                            {% else %}
                                <span class="badge bg-secondary">Staff</span>
                            {% endif %}
                        </td>

                        <!-- Action: Nút chỉnh sửa Role -->
                        <td>
                            <!-- LOGIC PHÂN QUYỀN HIỂN THỊ NÚT SỬA -->
                            
                            <!-- 1. Admin/Superuser: Thấy nút sửa của tất cả mọi người -->
                            {% if request.user.is_superuser or request.user.profile.role == 'Admin' %}
                                <!-- Sửa 'p.slug' thành 'p.pk' và tên url thành 'profile-update' -->
                                <a href="{% url 'profile-update' p.pk %}" class="btn btn-sm btn-info text-white" title="Edit Role">
                                    <i class="fa fa-pen"></i> Edit Role
                                </a>

                            <!-- 2. Manager: Thấy nút sửa của Staff và Manager khác (Trừ Admin và Superuser) -->
                            {% elif request.user.profile.role == 'Manager' and p.role != 'Admin' and not p.user.is_superuser %}
                                <a href="{% url 'profile-update' p.pk %}" class="btn btn-sm btn-info text-white" title="Edit Role">
                                    <i class="fa fa-pen"></i> Edit Role
                                </a>

                            <!-- 3. Còn lại (Staff hoặc Manager nhìn thấy Admin): Bị khóa -->
                            {% else %}
                                <span class="text-muted"><i class="fa fa-lock"></i> Locked</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}